# dbt source

## Overview

`dbt source` is a command group for managing sources. Currently, it has one subcommand:
- `dbt source freshness`: Check the freshness of source data

**Reference**: https://docs.getdbt.com/reference/commands/source

## Subcommand: `dbt source freshness`

### Task Class: `FreshnessTask`

`FreshnessTask` extends `RunTask` (via different inheritance) and queries sources to check data freshness.

### FreshnessRunner

`FreshnessRunner` extends `BaseRunner` and queries source tables for freshness.

## Implementation Quirks

### Metadata Freshness Cache

For adapters supporting metadata-based freshness (table modification time as opposed to based on the max value of a dedicated event timestamp column in the data), results are cached:

```python
class FreshnessRunner(BaseRunner):
    def __init__(self, ...):
        self._metadata_freshness_cache: Dict[BaseRelation, FreshnessResult] = {}
```

This avoids re-querying metadata for tables that share the same physical relation.

### Two Freshness Strategies

1. **Query-based**: `SELECT MAX(loaded_at_field) FROM source`
2. **Metadata-based**: Use adapter's `TableLastModifiedMetadata` capability

```python
if adapter.supports(Capability.TableLastModifiedMetadata):
    # Use metadata instead of query
    metadata = adapter.get_relation_last_modified(relation)
```

### Output Artifact

Writes `sources.json` (not `run_results.json`):

### Freshness Thresholds

Source freshness config defines thresholds:

```yaml
sources:
  - name: jaffle_shop
    freshness:
      warn_after: {count: 12, period: hour}
      error_after: {count: 24, period: hour}
    loaded_at_field: _etl_loaded_at
    tables:
      - name: orders
```

Status is determined by comparing the data age (time since `max_loaded_at`) against configured thresholds:

- If age exceeds `error_after` → **Error**
- If age exceeds `warn_after` → **Warn**
- Otherwise → **Pass**

## Flags

| Flag | Description |
|------|-------------|
| `--select` | Select sources to check |
| `--exclude` | Exclude sources |
| `--output` | Path for `sources.json` output |

## Output Format

`sources.json` structure:

```json
{
  "metadata": {...},
  "results": [
    {
      "unique_id": "source.my_project.jaffle_shop.orders",
      "status": "pass",
      "max_loaded_at": "2024-01-15T10:30:00Z",
      "snapshotted_at": "2024-01-15T11:00:00Z",
      "age": 1800.0,
      "criteria": {
        "warn_after": {"count": 12, "period": "hour"},
        "error_after": {"count": 24, "period": "hour"}
      }
    }
  ]
}
```

## Use Cases

1. **Data Quality Monitoring**: Alert when source data is stale
2. **CI/CD Gates**: Block deployments if sources are stale
3. **Dashboards**: Power freshness status dashboards
4. **Incident Detection**: Identify broken upstream pipelines

## Example

```bash
# Check all sources
dbt source freshness

# Check specific sources
dbt source freshness --select source:jaffle_shop

# Output to specific path
dbt source freshness --output freshness_results/sources.json
```
