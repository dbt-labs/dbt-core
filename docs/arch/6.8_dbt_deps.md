# dbt deps

## Overview

`dbt deps` downloads and installs dbt packages specified in `packages.yml` or `dependencies.yml`. It manages package resolution, version locking, and installation from the dbt Hub, git repositories, or local paths.

**Reference**: https://docs.getdbt.com/reference/commands/deps

## Task Class: `DepsTask`

`DepsTask` extends `BaseTask` (not `GraphRunnableTask`) because it doesn't require a manifest or database connection:

```python
class DepsTask(BaseTask):
    def __init__(self, args, project):
        super().__init__(args=args)
        self.project = project  # Only needs project config, not runtime config
```

## Implementation Quirks

### Lock File Management

`dbt deps` uses a two-file system:
- `packages.yml`: User-specified dependencies (version ranges allowed)
- `package-lock.yml`: Resolved, pinned versions

Resolution flow:
- If `packages.yml` changed or `--upgrade` is specified: resolve version ranges and update the lock file
- Otherwise: use pinned versions from the lock file directly

### SHA1 Hash Validation

The lock file includes a SHA1 hash of the serialized `packages.yml` contents. On each run, dbt computes the current hash and compares it to the stored hash. If they don't match, packages are re-resolved.

### `--add-package` Flag

Allows adding packages from CLI without editing `packages.yml`. Version is required unless the source is `local`.

### Package Sources

Three sources supported:

1. **Hub** (`package:`): Downloads from packages.getdbt.com
2. **Git** (`git:`): Clones from git repository
3. **Local** (`local:`): Uses local filesystem path

### No Profile Required

`@requires.unset_profile` decorator indicates deps doesn't need database credentials:

```python
@requires.unset_profile  # Skip profile loading
@requires.project        # Only need project config
def deps(ctx, **kwargs):
    ...
```

## Flags

| Flag | Description |
|------|-------------|
| `--source` | Package source: `hub`, `git`, or `local` |
| `--lock` | Update only the lock file without installing |
| `--upgrade` | Upgrade packages to latest matching versions |
| `--add-package` | Add a package (format: `name@version`) |

## Package Resolution

Packages are resolved in order of specificity:

```yaml
# packages.yml
packages:
  - package: dbt-labs/dbt_utils
    version: [">=1.0.0", "<2.0.0"]  # Version range
  - git: https://github.com/org/repo
    revision: v1.0.0                # Git ref
  - local: ../my-local-package      # Filesystem path
```

The lock file pins exact versions:

```yaml
# package-lock.yml
packages:
  - package: dbt-labs/dbt_utils
    version: 1.1.1
sha1_hash: abc123...
```
