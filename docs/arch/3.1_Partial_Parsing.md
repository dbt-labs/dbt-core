# Partial Parsing

## Overview

Partial parsing improves parse performance by reusing the previous manifest and only re-parsing files that have changed. Instead of reading and processing every file on each invocation, dbt compares file checksums against the saved manifest and selectively updates only what's necessary.

The saved manifest is stored in `target/partial_parse.msgpack`. On subsequent runs, if the state check passes and files can be diffed, dbt performs an incremental update rather than a full re-parse.

## State Check

Before using a saved manifest, `ManifestLoader.is_partial_parsable()` validates that the environment hasn't changed in ways that would invalidate the cached parse results:

- **Version match** — The saved manifest's dbt version must match the current version
- **Vars hash** — CLI `--vars`, profile name, and target name are hashed and compared
- **Profile hash** — Connection credentials info is hashed (changes could affect parsing)
- **Project env vars** — Environment variables used in `dbt_project.yml` are tracked
- **Project hashes** — Each project's `dbt_project.yml` content is hashed

If any check fails, a full re-parse is triggered and the reason is logged.

## File Diff Detection

The `PartialParsing` class compares the saved manifest's files against newly-read files:

```
prior run files  ∩  current run files  →  check checksums  →  changed / unchanged
prior run files  -  current run files  →  deleted
current run files    -  prior run files  →  added
```

Schema files (YAML) are tracked separately because they require element-level diffing: a change to one model's config in a YAML file shouldn't require re-parsing unrelated models in the same file.

### When Partial Parsing Is Bypassed

Partial parsing is skipped or abandoned in these cases:

- `--no-partial-parse` flag is set
- `partial_parse.msgpack` doesn't exist or can't be loaded
- dbt version mismatch
- Vars, profile, or project config changed
- An error occurs during partial parse processing (falls back to full re-parse)
- Special override macros were changed

When bypassed, a full re-parse occurs and a new `partial_parse.msgpack` is written for the next run.


## Processing Changes

`PartialParsing.get_parsing_files()` processes the file diff and returns a dictionary of files that need parsing:

### Added Files
- Add the file to `saved_manifest.files`
- Schedule for parsing

### Deleted Files
- Remove associated nodes from the manifest
- Schedule dependent nodes (children in the DAG) for re-parsing

### Changed Files
- Remove old nodes from the manifest
- Copy the new file content to saved files
- Schedule for parsing
- If the node had a schema patch, re-apply it

### Changed Schema Files
For YAML files, `change_schema_file()` performs element-level diffing:
- Compare saved vs. new YAML dictionaries key by key (models, sources, etc.)
- For each key, identify added/deleted/changed elements by name
- Only re-process affected elements, preserving unaffected nodes

## Special Macro Handling

Certain macros have global effects that make incremental updates unsafe. Changes to these "special override macros" trigger a full re-parse:

- `ref`
- `source`
- `config`
- `generate_schema_name`
- `generate_database_name`
- `generate_alias_name`

If a macro file containing any of these is changed or deleted, dbt abandons partial parsing and does a full re-parse.

## The `PartialParsing` Class

Located in `partial.py`, this class encapsulates the partial parsing logic:

**Constructor inputs:**
- `saved_manifest` — The previously-saved manifest
- `current run files` — Files read from the current project

**Key methods:**
- `skip_parsing()` — Returns `True` if no files changed (nothing to do)
- `build_file_diff()` — Compares saved vs. new files, populates `file_diff` dict
- `get_parsing_files()` — Processes the diff and returns files to parse
- `delete_from_saved()` / `update_in_saved()` — Handle individual file changes
- `change_schema_file()` — Handle YAML file changes with element-level granularity

**Key attributes:**
- `file_diff` — Dict with keys: `added`, `deleted`, `changed`, `unchanged`, `changed_schema_files`, `deleted_schema_files`
- `project_parser_files` — Output dict mapping `project → parser → [file_ids]`
