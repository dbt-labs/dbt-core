# dbt snapshot

## Overview

`dbt snapshot` executes snapshot definitions to capture slowly-changing dimension (SCD Type 2) history. Snapshots track changes to source data over time by maintaining historical records with validity timestamps.

**Reference**: https://docs.getdbt.com/reference/commands/snapshot

## Task Class: `SnapshotTask`

`SnapshotTask` extends `RunTask` but filters to only `NodeType.Snapshot` resources.

```python
class SnapshotTask(RunTask):
    def get_node_selector(self):
        return ResourceTypeSelector(
            resource_types=[NodeType.Snapshot],
            ...
        )
```

### SnapshotRunner

`SnapshotRunner` extends `ModelRunner` with snapshot-specific logging:

```python
class SnapshotRunner(ModelRunner):
    def describe_node(self) -> str:
        return "snapshot {}".format(self.get_node_representation())
    
    def print_result_line(self, result):
        # Includes snapshot config in output (strategy, unique_key, etc.)
        cfg = model.config.to_dict(omit_none=True)
        fire_event(LogSnapshotResult(..., cfg=cfg))
```

## Implementation Quirks

### Snapshot Strategy Detection

Snapshots use either `timestamp` or `check` strategy, configured in the snapshot definition:

- **timestamp**: Tracks changes via `updated_at` column
- **check**: Tracks changes by comparing all `check_cols`

The strategy is resolved during parsing and stored in `SnapshotNode.config.strategy`.

### Materialization Macro

Under the hood, snapshots use the `snapshot` materialization macro (not `table` or `incremental`). This macro:

1. Creates the snapshot table if it doesn't exist (with SCD columns: `dbt_scd_id`, `dbt_updated_at`, `dbt_valid_from`, `dbt_valid_to`)
2. Identifies new and changed records
3. Invalidates changed records (sets `dbt_valid_to`)
4. Inserts new records with current validity

### No Incremental Semantics

Unlike models with `incremental` materialization, snapshots don't support `--full-refresh` in the same way. The `--full-refresh` flag for snapshots rebuilds from scratch, losing historical data.

## Flags

| Flag | Description |
|------|-------------|
| `--select` | Select specific snapshots to execute |
| `--exclude` | Exclude snapshots |
