# dbt run-operation

## Overview

`dbt run-operation` executes a macro by name, allowing you to run arbitrary operations defined in your project. It's useful for administrative tasks, data migrations, or any custom logic that doesn't fit the standard model/test workflow.

**Reference**: https://docs.getdbt.com/reference/commands/run-operation

## Task Class: `RunOperationTask`

`RunOperationTask` extends `ConfiguredTask` (not `GraphRunnableTask`) since it executes a single macro, not a graph of nodes. 

## Implementation Quirks

### Macro Name Parsing

Supports both local and package-qualified macro names as input.

Examples:
- `my_macro` → searches in project
- `my_package.my_macro` → searches in specific package

### Macro Arguments

Arguments are passed via `--args` as a YAML dictionary:

```bash
dbt run-operation my_macro --args '{"my_arg": "value"}'
```

### Direct Adapter Execution

Unlike model execution, `run-operation` calls `adapter.execute_macro()` directly:

### Synthetic HookNode

Creates a `HookNode` for the result artifact (since macros aren't nodes):

```python
run_result = RunResult(
    node=HookNode(
        alias=macro_name,
        checksum=FileHash.from_contents(unique_id),
        resource_type=NodeType.Operation,
        fqn=fqn,
        name=macro_name,
        unique_id=unique_id,
        package_name=package_name,
        path="",
        original_file_path="",
    ),
    ...
)
```

### Transaction Clearing

Clears any existing transaction before execution:

### Return Value Not Used

The macro's return value is captured but not displayed:

```python
res = adapter.execute_macro(...)
# res is not used further
```

To output results, the macro should use `log()` or fire events.

## Flags

| Flag | Description |
|------|-------------|
| `MACRO` | Positional argument: macro name |
| `--args` | YAML dictionary of arguments |

## Use Cases

1. **Grant Management**: `dbt run-operation grant_select --args '{"role": "analyst"}'`
2. **Data Cleanup**: `dbt run-operation drop_old_partitions`
3. **Metadata Updates**: `dbt run-operation update_table_comments`
4. **Custom Maintenance**: Any DBA-style operations

## Example Macro

```sql
-- macros/grant_select.sql
{% macro grant_select(role) %}
  {% set sql %}
    GRANT SELECT ON ALL TABLES IN SCHEMA {{ target.schema }} TO ROLE {{ role }}
  {% endset %}
  
  {% do run_query(sql) %}
  {{ log("Granted SELECT to " ~ role, info=True) }}
{% endmacro %}
```

```bash
dbt run-operation grant_select --args '{"role": "analyst"}'
```

## Retry Behavior

`run-operation` results appear in `run_results.json` and are handled specially by `dbt retry`:
- Only retried if the previous command was `run-operation`
- Operation nodes are filtered out when retrying other commands
