[version]
path = "dbt/__version__.py"

[build.targets.wheel]
packages = ["dbt"]
only-packages = true
artifacts = [
    "dbt/include/**/*",
    "dbt/task/docs/**/*.html",
    "dbt/jsonschemas/**/*.json",
    "dbt/py.typed",
]

[build.targets.wheel.force-include]
"../LICENSE" = "LICENSE"

[build.targets.sdist]
include = [
    "/dbt",
    "/README.md",
]

[build.targets.sdist.force-include]
"../LICENSE" = "LICENSE"
"dbt/task/docs/index.html" = "dbt/task/docs/index.html"

[envs.default]
dependencies = [
    "pre-commit~=3.7.0",
    "pytest>=7.0,<8.0",
    "pytest-xdist~=3.6",
    "pytest-csv~=3.0",
    "pytest-logbook~=1.2",
    "logbook<1.9",
    "mypy>=1.9,<2.0",
    "flake8>=6.0,<7.0",
    "black>=24.3,<25.0",
]

[envs.default.scripts]
# Setup commands
setup = [
    "pip install -r ../dev-requirements.txt",
    "pip install -e .",
    "pre-commit install",
]
dev-req = [
    "pip install -r ../dev-requirements.txt",
    "pip install -e .",
]

# Code quality commands
code-quality = "pre-commit run --all-files --show-diff-on-failure"
lint = [
    "pre-commit run flake8-check --hook-stage manual --all-files",
    "pre-commit run mypy-check --hook-stage manual --all-files",
]
flake8 = "pre-commit run flake8-check --hook-stage manual --all-files"
mypy = "pre-commit run mypy-check --hook-stage manual --all-files"
black = "pre-commit run black-check --hook-stage manual --all-files"

# Testing commands
unit-tests = "python -m pytest {args} ../tests/unit"
integration-tests = "python -m pytest -nauto {args} ../tests/functional"
integration-tests-fail-fast = "python -m pytest -x -nauto {args} ../tests/functional"
test = [
    "python -m pytest ../tests/unit",
    "pre-commit run black-check --hook-stage manual --all-files",
    "pre-commit run flake8-check --hook-stage manual --all-files",
    "pre-commit run mypy-check --hook-stage manual --all-files",
]

# Database setup
setup-db = [
    "docker compose up -d database",
    "bash ../test/setup_db.sh",
]

# Utility commands
clean = [
    "rm -f .coverage",
    "rm -f .coverage.*",
    "rm -rf .eggs/",
    "rm -rf build/",
    "rm -rf dbt.egg-info/",
    "rm -f dbt_project.yml",
    "rm -rf dist/",
    "find . -type f -name '*.pyc' -delete",
    "find . -type d -name __pycache__ -exec rm -rf {} +",
]
json-schema = "python ../scripts/collect-artifact-schema.py --path ../schemas"

[envs.build]
detached = true
dependencies = [
    "wheel",
    "twine",
    "check-wheel-contents",
]

[envs.build.scripts]
check-all = [
    "- check-wheel",
    "- check-sdist",
]
check-wheel = [
    "twine check dist/*",
    "find ./dist/dbt_core-*.whl -maxdepth 1 -type f | xargs python -m pip install --force-reinstall --find-links=dist/",
    "pip freeze | grep dbt-core",
    "dbt --version",
]
check-sdist = [
    "check-wheel-contents dist/*.whl --ignore W007,W008",
    "find ./dist/dbt_core-*.gz -maxdepth 1 -type f | xargs python -m pip install --force-reinstall --find-links=dist/",
    "pip freeze | grep dbt-core",
    "dbt --version",
]

# CI environment - isolated environment with test dependencies
[envs.ci]
dependencies = [
    "pytest>=7.0,<8.0",
    "pytest-cov",
    "pytest-xdist~=3.6",
    "pytest-csv~=3.0",
    "pytest-dotenv",
    "pytest-mock",
    "pytest-split",
    "ddtrace==2.21.3",
    "flaky",
    "freezegun>=1.5.1",
    "hypothesis",
]
pre-install-commands = [
    "pip install -r ../dev-requirements.txt",
    "pip install -e .",
]

[envs.ci.env-vars]
DBT_TEST_USER_1 = "dbt_test_user_1"
DBT_TEST_USER_2 = "dbt_test_user_2"
DBT_TEST_USER_3 = "dbt_test_user_3"

[envs.ci.scripts]
unit-tests = "python -m pytest --cov=dbt --cov-report=xml {args} ../tests/unit"
integration-tests = [
    "python -m pytest --cov=dbt --cov-append --cov-report=xml {args} ../tests/functional -k \"not tests/functional/graph_selection\"",
    "python -m pytest --cov=dbt --cov-append --cov-report=xml {args} ../tests/functional/graph_selection",
]

# Matrix testing across Python versions
[[envs.ci.matrix]]
python = [
    "3.10",
    "3.11",
    "3.12",
    "3.13",
]
